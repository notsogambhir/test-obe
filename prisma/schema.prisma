generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id                 String              @id @default(cuid())
  email              String?             @unique
  studentId          String?             @unique
  employeeId         String?             @unique
  password           String
  name               String
  role               UserRole            @default("TEACHER")
  collegeId          String?
  programId          String?
  batchId            String?
  sectionId          String?
  isActive           Boolean             @default(true)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  coAttainments      COAttainment[]
  enrollments        Enrollment[]
  studentMarks       StudentMark[]
  teacherAssignments TeacherAssignment[]
  section            Section?            @relation(fields: [sectionId], references: [id])
  batch              Batch?              @relation("BatchStudents", fields: [batchId], references: [id])
  program            Program?            @relation("ProgramUsers", fields: [programId], references: [id])
  college            College?            @relation(fields: [collegeId], references: [id])

  @@map("users")
}

model College {
  id          String    @id @default(cuid())
  name        String    @unique
  code        String    @unique
  description String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  programs    Program[]
  users       User[]

  @@map("colleges")
}

model Program {
  id          String   @id @default(cuid())
  name        String
  code        String
  collegeId   String
  duration    Int
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  batches     Batch[]
  pos         PO[]
  college     College  @relation(fields: [collegeId], references: [id])
  users       User[]   @relation("ProgramUsers")

  @@unique([collegeId, code])
  @@map("programs")
}

model Batch {
  id        String    @id @default(cuid())
  name      String
  programId String
  startYear Int
  endYear   Int
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  program   Program   @relation(fields: [programId], references: [id])
  courses   Course[]
  sections  Section[]
  students  User[]    @relation("BatchStudents")

  @@unique([programId, name])
  @@map("batches")
}

model Section {
  id                 String              @id @default(cuid())
  name               String
  batchId            String
  isActive           Boolean             @default(true)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  assessments        Assessment[]
  coAttainments      COAttainment[]
  batch              Batch               @relation(fields: [batchId], references: [id])
  studentMarks       StudentMark[]
  teacherAssignments TeacherAssignment[]
  students           User[]

  @@unique([batchId, name])
  @@map("sections")
}

model Course {
  id                 String              @id @default(cuid())
  code               String
  name               String
  batchId            String
  description        String?
  status             CourseStatus        @default("FUTURE")
  targetPercentage   Float               @default(50.0)
  level1Threshold    Float               @default(50.0)
  level2Threshold    Float               @default(70.0)
  level3Threshold    Float               @default(80.0)
  isActive           Boolean             @default(true)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  assessments        Assessment[]
  coAttainments      COAttainment[]
  coPOMappings       COPOMapping[]
  courseOutcomes     CO[]
  batch              Batch               @relation(fields: [batchId], references: [id])
  enrollments        Enrollment[]
  teacherAssignments TeacherAssignment[]

  @@unique([batchId, code])
  @@map("courses")
}

model CO {
  id            String              @id @default(cuid())
  courseId      String
  code          String
  description   String
  isActive      Boolean             @default(true)
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  coAttainments COAttainment[]
  mappings      COPOMapping[]
  course        Course              @relation(fields: [courseId], references: [id])
  coMappings    QuestionCOMapping[]

  @@unique([courseId, code])
  @@map("cos")
}

model PO {
  id          String        @id @default(cuid())
  programId   String
  code        String
  description String
  isActive    Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  mappings    COPOMapping[]
  program     Program       @relation(fields: [programId], references: [id])

  @@unique([programId, code])
  @@map("pos")
}

model PEO {
  id          String   @id @default(cuid())
  programId   String
  code        String
  description String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([programId, code])
  @@map("peos")
}

model COPOMapping {
  id       String  @id @default(cuid())
  coId     String
  poId     String
  courseId String
  level    Int
  isActive Boolean @default(true)
  course   Course  @relation(fields: [courseId], references: [id])
  po       PO      @relation(fields: [poId], references: [id])
  co       CO      @relation(fields: [coId], references: [id])

  @@unique([coId, poId, courseId])
  @@map("co_po_mappings")
}

model TeacherAssignment {
  id        String   @id @default(cuid())
  courseId  String
  sectionId String?
  teacherId String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  teacher   User     @relation(fields: [teacherId], references: [id])
  section   Section? @relation(fields: [sectionId], references: [id])
  course    Course   @relation(fields: [courseId], references: [id])

  @@unique([courseId, sectionId, teacherId])
  @@map("teacher_assignments")
}

model Assessment {
  id        String     @id @default(cuid())
  courseId  String
  sectionId String?
  name      String
  type      String
  maxMarks  Int
  weightage Float
  isActive  Boolean    @default(true)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  section   Section?   @relation(fields: [sectionId], references: [id])
  course    Course     @relation(fields: [courseId], references: [id])
  questions Question[]

  @@unique([courseId, sectionId, name])
  @@map("assessments")
}

model Question {
  id           String              @id @default(cuid())
  assessmentId String
  question     String
  maxMarks     Int
  isActive     Boolean             @default(true)
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  coMappings   QuestionCOMapping[]
  assessment   Assessment          @relation(fields: [assessmentId], references: [id])
  studentMarks StudentMark[]

  @@map("questions")
}

model QuestionCOMapping {
  id         String   @id @default(cuid())
  questionId String
  coId       String
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  co         CO       @relation(fields: [coId], references: [id], onDelete: Cascade)
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([questionId, coId])
  @@map("question_co_mappings")
}

model Enrollment {
  id        String   @id @default(cuid())
  courseId  String
  studentId String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  student   User     @relation(fields: [studentId], references: [id])
  course    Course   @relation(fields: [courseId], references: [id])

  @@unique([courseId, studentId])
  @@map("enrollments")
}

model COAttainment {
  id           String   @id @default(cuid())
  courseId     String
  sectionId    String?
  coId         String
  studentId    String
  percentage   Float
  metTarget    Boolean
  calculatedAt DateTime @default(now())
  academicYear String?
  student      User     @relation(fields: [studentId], references: [id])
  co           CO       @relation(fields: [coId], references: [id])
  section      Section? @relation(fields: [sectionId], references: [id])
  course       Course   @relation(fields: [courseId], references: [id])

  @@unique([courseId, sectionId, coId, studentId, academicYear])
  @@map("co_attainments")
}

model StudentMark {
  id            String   @id @default(cuid())
  questionId    String
  sectionId     String?
  studentId     String
  obtainedMarks Int?
  maxMarks      Int
  submittedAt   DateTime @default(now())
  academicYear  String?
  student       User     @relation(fields: [studentId], references: [id])
  section       Section? @relation(fields: [sectionId], references: [id])
  question      Question @relation(fields: [questionId], references: [id])

  @@unique([questionId, sectionId, studentId, academicYear])
  @@map("student_marks")
}

enum UserRole {
  ADMIN
  UNIVERSITY
  DEPARTMENT
  PROGRAM_COORDINATOR
  TEACHER
  STUDENT
}

enum CourseStatus {
  FUTURE
  ACTIVE
  COMPLETED
}
